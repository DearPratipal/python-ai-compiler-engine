<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Code to Image Converter</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CodeMirror for a better code editor experience -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/material-darker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/python/python.min.js"></script>
    <!-- html2canvas for converting DOM elements to images -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Pyodide to run Python in the browser -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <style>
        /* Custom styles for a better look and feel */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            /* Dark background */
        }

        /* Style for the CodeMirror editor */
        .CodeMirror {
            border: 1px solid #374151;
            height: 300px;
            border-radius: 0.5rem;
            font-size: 16px;
        }

        .cm-s-material-darker.CodeMirror {
            background-color: #1f2937;
        }

        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1f2937;
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Adding a subtle glow to the buttons on hover */
        .btn-glow:hover {
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }
    </style>
    <!-- Google Fonts for a nicer typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body class="text-white">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">

        <header class="text-center mb-8">
            <h1
                class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">
                Python Code Runner & Imager</h1>
            <p class="text-gray-400 mt-2">Write Python code, see text and plot outputs, and save it all as an image.</p>
        </header>

        <main class="bg-gray-800 rounded-lg shadow-2xl p-6">
            <!-- Code Input Section -->
            <div>
                <label for="code-editor" class="text-lg font-semibold mb-2 block">Your Python Code</label>
                <textarea id="code-editor" class="w-full"></textarea>
            </div>

            <!-- Run Button -->
            <div class="text-center my-6">
                <button id="run-button"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105 btn-glow flex items-center justify-center mx-auto">
                    <!-- SVG Spinner for loading state -->
                    <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden"
                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                    <span id="run-button-text">Run Code</span>
                </button>
            </div>

            <!-- Output Section -->
            <div id="output-section" class="hidden">
                <h2 class="text-lg font-semibold mb-2">Output</h2>
                <!-- This is the container that will be converted to an image -->
                <div id="output-image-area" class="bg-black p-4 rounded-lg">
                    <pre id="output-container" class="text-white whitespace-pre-wrap break-words font-mono"></pre>
                    <div id="plot-output-container" class="mt-4 flex justify-center"></div>
                </div>
                <!-- Action buttons for the output image -->
                <div id="image-actions" class="flex flex-wrap gap-4 mt-4 justify-center">
                    <button id="download-png"
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 btn-glow">Download
                        as PNG</button>
                    <button id="download-jpg"
                        class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 btn-glow">Download
                        as JPG</button>
                    <button id="copy-png"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 btn-glow">Copy
                        as PNG</button>
                </div>
                <!-- A message area for copy status -->
                <p id="copy-status" class="text-center mt-3 text-sm text-gray-400 h-5"></p>
            </div>

        </main>

        <footer class="text-center mt-8 text-gray-500 text-sm">
            <p>Powered & Developed by Pratipal Kumar Singh</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            // --- DOM Element References ---
            const runButton = document.getElementById('run-button');
            const runButtonText = document.getElementById('run-button-text');
            const spinner = document.getElementById('spinner');
            const outputSection = document.getElementById('output-section');
            const outputContainer = document.getElementById('output-container');
            const plotOutputContainer = document.getElementById('plot-output-container');
            const outputImageArea = document.getElementById('output-image-area');
            const downloadPngButton = document.getElementById('download-png');
            const downloadJpgButton = document.getElementById('download-jpg');
            const copyPngButton = document.getElementById('copy-png');
            const copyStatus = document.getElementById('copy-status');

            // --- CodeMirror Initialization ---
            const editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
                mode: 'python',
                theme: 'material-darker',
                lineNumbers: true,
                autoCloseBrackets: true,
                matchBrackets: true,
                indentUnit: 4,
            });

            // Set default code with a matplotlib example
            editor.setValue(`# Welcome! You can now run libraries like Matplotlib!\nimport matplotlib.pyplot as plt\nimport numpy as np\n\n# Data for plotting\nt = np.arange(0.0, 2.0, 0.01)\ns = 1 + np.sin(2 * np.pi * t)\n\n# Create the plot\nfig, ax = plt.subplots()\nax.plot(t, s)\n\nax.set(xlabel='time (s)', ylabel='voltage (mV)',\n       title='A Simple Matplotlib Plot')\nax.grid()\n\n# The plot will be automatically displayed below.\n# No need for plt.show()\nprint("Plot generated successfully!")`);

            // --- Pyodide Initialization ---
            let pyodide;
            try {
                setLoading(true, 'Initializing Environment...');
                pyodide = await loadPyodide();
                await pyodide.loadPackage("matplotlib");
                await pyodide.loadPackage("numpy");
                setLoading(false);
                console.log("Pyodide and packages loaded successfully.");
            } catch (error) {
                console.error("Pyodide failed to load:", error);
                setLoading(false, 'Initialization Failed');
                runButton.disabled = true;
                alert("Could not initialize the Python environment. Please refresh the page.");
            }


            // --- Event Listeners ---
            runButton.addEventListener('click', executeCode);
            downloadPngButton.addEventListener('click', () => downloadImage('png'));
            downloadJpgButton.addEventListener('click', () => downloadImage('jpeg'));
            copyPngButton.addEventListener('click', copyImage);

            // --- Core Functions ---

            /**
             * Executes the Python code using Pyodide.
             */
            async function executeCode() {
                const code = editor.getValue();
                if (!code.trim() || !pyodide) {
                    alert("Please write some code before running.");
                    return;
                }

                setLoading(true);
                outputSection.classList.add('hidden');
                copyStatus.textContent = '';
                outputContainer.textContent = '';
                plotOutputContainer.innerHTML = '';

                try {
                    let capturedOutput = "";
                    // Redirect stdout and stderr to capture print statements and errors
                    pyodide.setStdout({ batched: (str) => capturedOutput += str + "\n" });
                    pyodide.setStderr({ batched: (str) => capturedOutput += `\n--- ERROR ---\n${str}\n` });

                    // Clear any previous plots before running the new code
                    await pyodide.runPythonAsync("import matplotlib.pyplot as plt; plt.close('all')");

                    await pyodide.runPythonAsync(code);

                    // Check if matplotlib created any figures
                    const figCount = await pyodide.runPythonAsync("len(plt.get_fignums())");

                    if (figCount > 0) {
                        // If there's a plot, convert it to a base64 image string
                        const image_b64 = await pyodide.runPythonAsync(`
                            import base64
                            from io import BytesIO
                            
                            fig = plt.gcf()
                            buf = BytesIO()
                            fig.savefig(buf, format='png', bbox_inches='tight')
                            buf.seek(0)
                            base64.b64encode(buf.read()).decode('utf-8')
                        `);

                        const img = document.createElement('img');
                        img.src = `data:image/png;base64,${image_b64}`;
                        img.className = 'mx-auto bg-white rounded-md p-1'; // White bg for better visibility
                        plotOutputContainer.appendChild(img);
                    }

                    // Display the captured text output
                    if (capturedOutput.trim() === '' && figCount === 0) {
                        outputContainer.textContent = '[No output produced]';
                    } else {
                        outputContainer.textContent = capturedOutput.trim();
                    }

                    outputSection.classList.remove('hidden');

                } catch (error) {
                    console.error("Error executing code:", error);
                    outputContainer.textContent = `An error occurred while executing the code:\n${error.message}`;
                    outputSection.classList.remove('hidden');
                } finally {
                    setLoading(false);
                }
            }

            /**
             * Generates an image from the output area and triggers a download.
             */
            function downloadImage(format) {
                html2canvas(outputImageArea, {
                    backgroundColor: '#000000',
                    scale: 2 // Increase resolution
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `code_output.${format}`;
                    link.href = canvas.toDataURL(`image/${format}`, format === 'jpeg' ? 0.9 : 1.0);
                    link.click();
                });
            }

            /**
             * Generates an image and copies it to the clipboard.
             */
            async function copyImage() {
                copyStatus.textContent = 'Copying...';
                try {
                    const canvas = await html2canvas(outputImageArea, {
                        backgroundColor: '#000000',
                        scale: 2
                    });
                    canvas.toBlob(async (blob) => {
                        try {
                            await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
                            copyStatus.textContent = 'Copied to clipboard!';
                        } catch (err) {
                            console.error('Failed to copy image: ', err);
                            copyStatus.textContent = 'Copy failed. Your browser might not support it.';
                        }
                    }, 'image/png');
                } catch (err) {
                    console.error('html2canvas failed: ', err);
                    copyStatus.textContent = 'Could not generate image.';
                }
            }

            /**
             * Toggles the loading state of the run button.
             */
            function setLoading(isLoading, text = 'Run Code') {
                const buttonText = text === 'Run Code' && isLoading ? 'Running...' : text;
                runButtonText.textContent = buttonText;

                if (isLoading) {
                    runButton.disabled = true;
                    runButton.classList.add('opacity-50', 'cursor-not-allowed');
                    spinner.classList.remove('hidden');
                } else {
                    runButton.disabled = false;
                    runButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    spinner.classList.add('hidden');
                }
            }
        });
    </script>
</body>

</html>